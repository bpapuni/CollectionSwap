@model CollectionSwap.Models.SwapViewModel
@using CollectionSwap.Models
@using Newtonsoft.Json;
@{
    ViewBag.Title = "Find Swaps";
    UserCollection selectedCollection = ViewBag.SelectedCollection;
    List<(string, List<List<int>>, List<List<int>>)> potentialSwappers = ViewBag.PotentialSwappers;
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<main aria-labelledby="title">
    <h2 id="title">@ViewBag.Title</h2>
    <hr />
    <div class="secondary-container">
        <h5>Select a collection to find swaps for:</h5>
        @*<hr />*@
        @*User Collection Select*@
        <div class="d-flex gap-5">
            @foreach (UserCollection userCollection in Model.UserCollections)
            {
                <div class="d-flex flex-column align-items-center">
                    @Html.ActionLink(userCollection.Name, "UserCollection", "Swap", new { id = userCollection.Id }, new { @class = "collection user-collection" })
                </div>
            }
        </div>
    </div>
    <br />

    @*Available Swaps*@
    @if (potentialSwappers != null)
    {
        if (potentialSwappers.Count > 0)
        {
            <div class="d-flex flex-column gap-3">
                <div>
                    <h4>Available Swaps You Need:</h4>
                    <h6>(Highest rated first)</h6>
                </div>

                @foreach (var potentialSwapper in potentialSwappers)
                {
                    var collection = Model.Collections.Where(col => col.Id == selectedCollection.CollectionId).FirstOrDefault();
                    var itemList = JsonConvert.DeserializeObject<List<string>>(collection.ItemListJSON);

                    <h5>User: @potentialSwapper.Item1</h5>
                    <div class="swap-container">
                        @foreach (var potentialSwap in potentialSwapper.Item3)
                        {
                            var swapIndex = potentialSwapper.Item3.IndexOf(potentialSwap);

                            if (swapIndex == 0)
                            {
                                <div class="swap-container-main">
                                    @foreach (var item in potentialSwap)
                                    {
                                        var fileName = itemList[item];
                                        var imagePath = $"~/Collections/{selectedCollection.CollectionId}/{fileName}";
                                        <div class="swap-feature-item">
                                            <span class="swap-item-name">@(item + 1)</span>
                                            <img class="item" src="@Url.Content(imagePath)" />
                                        </div>
                                    }
                                </div>
                            }
                        }


                        <div class="swap-container-sub">
                            @foreach (var potentialSwap in potentialSwapper.Item3)
                            {
                                var swapIndex = potentialSwapper.Item3.IndexOf(potentialSwap);

                                if (swapIndex == 0)
                                {
                                    <div class="swap swap-selected">
                                        @foreach (var item in potentialSwap)
                                        {
                                            var fileName = itemList[item];
                                            var imagePath = $"~/Collections/{selectedCollection.CollectionId}/{fileName}";
                                            <div class="swap-resize">
                                                <span class="swap-item-name">@(item + 1)</span>
                                                <img class="item" src="@Url.Content(imagePath)" />
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="swap">
                                        @foreach (var item in potentialSwap)
                                        {
                                            var fileName = itemList[item];
                                            var imagePath = $"~/Collections/{selectedCollection.CollectionId}/{fileName}";
                                            <div class="swap-resize">
                                                <span class="swap-item-name">@(item + 1)</span>
                                                <img class="item" src="@Url.Content(imagePath)" />
                                            </div>
                                        }
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <h5> No potential swappers found.</h5>
        }
    }
</main>

@section scripts {
    <script>
        const id = window.location.href.split("UserCollection/")[1];
        const selectedCollection = $(`[href='/Swap/UserCollection/${id}']`);

        if (selectedCollection.length) {
            selectedCollection.addClass("user-collection-selected")
        }

        $(".swap").on("click", function () {
            const potentialSwappers = @Html.Raw(JsonConvert.SerializeObject(potentialSwappers));
            const swapperIndex =$(".swap-container").index($(this).closest(".swap-container"));
            const swapIndex = $(this).index();
            //potentialSwappers[swapperIndex].Item3[swapIndex]

            const featuredItems = $(".swap-container").eq(swapperIndex).find(".swap-feature-item");

            featuredItems.each(function (i, e) {
                let regex = /\/(\d+)\./;
                let newSrc = $(this).find("img").attr("src");
                const replaceStr = newSrc.match(regex)[0];
                const fileName = potentialSwappers[swapperIndex].Item3[swapIndex][i] + 1;
                newSrc = newSrc.replace(replaceStr, `/${fileName}.`)

                $(e).fadeOut(400, function (i) {
                    $(this).find(".swap-item-name").text(fileName);
                    $(this).find("img").attr("src", newSrc);
                    $(e).fadeIn();
                });
            });

            $(".swap-container").eq(swapperIndex).find(".swap").not(this).removeClass("swap-selected");
            $(this).addClass("swap-selected");
        })
    </script>
}