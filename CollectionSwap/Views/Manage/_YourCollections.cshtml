@model CollectionSwap.Models.YourCollectionViewModel
@using CollectionSwap.Models
@using Newtonsoft.Json
@{
    var mcViewModel = new ManageCollectionsViewModel
    {
        Collections = Model.Collections
    };
}


<div class="scroll-snap-row">
    <div class="column">
        <div id="create-user-collection-container" style="display: none">
            @Html.Partial("_ManageCollections", mcViewModel)
            <button class="close" onclick="$(this).parent().slideUp()"><i class="fa fa-times"></i></button>
        </div>

        <span class="header">
            Your Collections
        </span>
        <div id="your-collections-container">
            <section class="min-width-100 gap-2">
                @{
                    var createCollectionButton = new CollectionButton
                    {
                        Id = 0,
                        Name = "Add New Collection",
                        ItemList = new List<string>(),
                    };
                }

                <a class="collection-button" href="/Manage/YourCollections/#" onClick="$('#create-user-collection-container').slideDown()" )>
                    @Html.Partial("_CollectionButton", createCollectionButton)
                </a>

                @foreach (var userCollection in Model.UserCollections)
                {
                    var collection = Model.Collections.Where(c => c.Id == userCollection.CollectionId).FirstOrDefault();
                    var deserializedItemListJSON = JsonConvert.DeserializeObject<List<string>>(collection.ItemListJSON);
                    var userItemList = JsonConvert.DeserializeObject<List<int>>(userCollection.ItemCountJSON)
                                                    .Select((value, index) => new { Value = value, Index = index })
                                                    .Where(item => item.Value > 0)
                                                    .Select(item => item.Index)
                                                    .ToList();
                    var duplicates = JsonConvert.DeserializeObject<List<int>>(userCollection.ItemCountJSON)
                                                    .Select(num => num > 1 ? num - 1 : 0).ToList()
                                                    .Sum();

                    var collectionButton = new CollectionButton
                    {
                        Id = userCollection.CollectionId,
                        Name = userCollection.Name,
                        ItemList = userItemList.Select(index => deserializedItemListJSON[index]).ToList(),
                        SetSize = deserializedItemListJSON.Count,
                        Duplicates = duplicates
                    };
                    <div class="column align-items-center gap-1">
                        <a class="collection-button" href=@Url.Content($"/Manage/YourCollections/{userCollection.Id}")>
                            @Html.Partial("_CollectionButton", collectionButton)
                        </a>

                        @using (Html.BeginForm("DeleteUserCollection", "Manage", new { id = @userCollection.Id }, FormMethod.Post))
                        {
                            @Html.AntiForgeryToken()
                            <button class="button-icon button-icon-trash" type="submit" onclick="return confirm('Are you sure you want to delete this set?')"><i class="fa fa-trash"></i></button>
                        }
                    </div>
                }
            </section>
        </div>
    </div>


    <div id="user-collection-container" class="d-none">
        @if (Model.EditCollection != null)
        {
            @Html.Partial("_UserCollection", Model.EditCollection)
        }
    </div>
</div>